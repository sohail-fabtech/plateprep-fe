# Canvas Export & S3 Upload - Architecture Diagram

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TEMPLATE EDITOR                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Editor.tsx                                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ Canvas Element (fabric.js)                                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ useHistory Hook                                                  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ saveCallback (debounced 500ms)                               â”‚   â”‚
â”‚  â”‚  â””â”€ useEditor Hook                                                   â”‚   â”‚
â”‚  â”‚     â”œâ”€ savePng(), saveSvg(), saveJson()                             â”‚   â”‚
â”‚  â”‚     â””â”€ canvas instance                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ First Save Detected
                  â”‚ (isFirstSave flag)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               canvasExportService.ts                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  exportCanvasAndUploadToS3()                                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ exportCanvasToBlob()                                             â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Detect images in canvas                                       â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Process images (CORS handling)                                â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Test if CORS-compliant                                    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Reload if tainted                                         â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ Cache busting with timestamp                              â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Export to PNG blob                                            â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Primary: fabric.toDataURL()                                â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Fallback: manualCanvasRender()                             â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ High DPI (2x multiplier)                                   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Return Blob                                                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ Create File from Blob                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€ generateFileKey()                                                â”‚   â”‚
â”‚  â”‚  â””â”€ uploadFileWithPresignedUrl()                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Uploads file
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            presignedUrlService.ts                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  uploadFileWithPresignedUrl()                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€ getPresignedUrl()                                                â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ POST /presigned_url/request_upload/                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ uploadFileToS3()                                                 â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ PUT <presigned_url>  (with File content)                      â”‚   â”‚
â”‚  â”‚  â””â”€ constructS3Url()                                                 â”‚   â”‚
â”‚  â”‚     â””â”€ https://bucket.s3.amazonaws.com/filename.ext                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Returns S3 URL
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Backend API                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  GET /presigned_url/request_upload/                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ Input: { file: "filename.png" }                                 â”‚   â”‚
â”‚  â”‚  â””â”€ Output: { presigned_url, expires_in, key }                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Returns presigned URL
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AWS S3                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  s3://bucket/                                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€ template_designs/                                                â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ 1735975200000_abc123.png  âœ…                                 â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ 1735975200001_def456.png  âœ…                                 â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ...                                                           â”‚   â”‚
â”‚  â”‚  â””â”€ (public read access)                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ S3 URL
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Editor (Save Callback)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Create Payload                                                      â”‚   â”‚
â”‚  â”‚  {                                                                   â”‚   â”‚
â”‚  â”‚    title: "Untitled Design",                                         â”‚   â”‚
â”‚  â”‚    image: "https://bucket.s3.amazonaws.com/...", âœ… S3 URL          â”‚   â”‚
â”‚  â”‚    source: { /* canvas JSON */ },                                    â”‚   â”‚
â”‚  â”‚    metadata: { width, height, uploadedAt }                           â”‚   â”‚
â”‚  â”‚  }                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€ Show Notification âœ…
                  â”œâ”€ Log to Console ğŸ“
                  â””â”€ Ready for API save
```

---

## Data Flow Sequence

```
User               Editor           Service         Backend         S3
 â”‚                  â”‚                â”‚                â”‚              â”‚
 â”‚ Make Changes     â”‚                â”‚                â”‚              â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚              â”‚
 â”‚                  â”‚ save() triggered               â”‚              â”‚
 â”‚                  â”‚ (every 500ms debounced)        â”‚              â”‚
 â”‚                  â”‚                â”‚                â”‚              â”‚
 â”‚                  â”‚ isFirstSave?   â”‚                â”‚              â”‚
 â”‚                  â”‚ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
 â”‚                  â”‚                â”‚ exportCanvasToBlob()         â”‚
 â”‚                  â”‚                â”‚ (process images + export)   â”‚
 â”‚                  â”‚                â”‚ Returns Blob               â”‚
 â”‚                  â”‚                â”‚                â”‚              â”‚
 â”‚                  â”‚                â”‚                â”‚              â”‚
 â”‚                  â”‚                â”‚ generateFileKey()           â”‚
 â”‚                  â”‚                â”‚                â”‚              â”‚
 â”‚                  â”‚                â”‚ getPresignedUrl()          â”‚
 â”‚                  â”‚                â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
 â”‚                  â”‚                â”‚ presigned_url              â”‚
 â”‚                  â”‚                â”‚                â”‚              â”‚
 â”‚                  â”‚                â”‚ uploadFileToS3(presigned_url)
 â”‚                  â”‚                â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                  â”‚                â”‚                â”‚ File uploaded
 â”‚                  â”‚                â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 â”‚                  â”‚                â”‚ S3 URL                     â”‚
 â”‚                  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚              â”‚
 â”‚                  â”‚ Create Payload with S3 URL      â”‚              â”‚
 â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Show Success Notification       â”‚              â”‚
 â”‚  âœ… Saved!       â”‚                â”‚                â”‚              â”‚
 â”‚                  â”‚                â”‚                â”‚              â”‚
 â”‚ More Changes    â”‚                â”‚                â”‚              â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚              â”‚
 â”‚                  â”‚ save() triggered               â”‚              â”‚
 â”‚                  â”‚ (debounced)    â”‚                â”‚              â”‚
 â”‚                  â”‚                â”‚                â”‚              â”‚
 â”‚                  â”‚ isFirstSave?   â”‚                â”‚              â”‚
 â”‚                  â”‚ NO             â”‚                â”‚              â”‚
 â”‚                  â”‚ Log payload with dataUrl       â”‚              â”‚
 â”‚                  â”‚ (console output only)          â”‚              â”‚
 â”‚                  â”‚                â”‚                â”‚              â”‚
 â”‚ More changes... â”‚                â”‚                â”‚              â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Organization

```
src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ templateEditor/
â”‚   â”‚   â””â”€â”€ canvasExportService.ts
â”‚   â”‚       â”œâ”€ exportCanvasToBlob()
â”‚   â”‚       â”œâ”€ exportCanvasAndUploadToS3()
â”‚   â”‚       â”œâ”€ exportCanvasWithPayload()
â”‚   â”‚       â”œâ”€ processImageObject()
â”‚   â”‚       â”œâ”€ manualCanvasRender()
â”‚   â”‚       â””â”€ dataUrlToBlob()
â”‚   â”‚
â”‚   â”œâ”€â”€ presignedUrl/
â”‚   â”‚   â”œâ”€ presignedUrlService.ts (existing)
â”‚   â”‚   â”‚   â”œâ”€ getPresignedUrl()
â”‚   â”‚   â”‚   â”œâ”€ uploadFileToS3()
â”‚   â”‚   â”‚   â”œâ”€ uploadFileWithPresignedUrl()
â”‚   â”‚   â”‚   â””â”€ generateFileKey()
â”‚   â”‚   â””â”€ presignedUrlHooks.ts (existing)
â”‚   â”‚
â”‚   â””â”€â”€ index.ts
â”‚       â””â”€ Export all service functions
â”‚
â””â”€â”€ sections/
    â””â”€â”€ @dashboard/
        â””â”€â”€ templateEditor/
            â”œâ”€â”€ components/
            â”‚   â””â”€â”€ Editor.tsx (modified)
            â”‚       â””â”€ saveCallback with export logic
            â”‚
            â””â”€â”€ hooks/
                â””â”€â”€ useHistory.ts (modified)
                    â””â”€ Debounced saveCallback
```

---

## State Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Editor.tsx        â”‚
â”‚                      â”‚
â”‚ State:               â”‚
â”‚ â”œâ”€ activeTool       â”‚
â”‚ â”œâ”€ isFirstSave â”€â”€â”  â”‚
â”‚ â””â”€ [other state] â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  First Save Logic   â”‚
        â”‚                     â”‚
        â”‚ isFirstSave = true  â”‚
        â”‚    â†“                â”‚
        â”‚ Export & Upload    â”‚
        â”‚    â†“                â”‚
        â”‚ isFirstSave = false â”‚
        â”‚    â†“                â”‚
        â”‚ Log payload        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling Flow

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Export Canvas      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Success?            â”‚
                    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                       â”‚ Yes          â”‚ No
                       â”‚              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Upload to S3  â”‚    â”‚ Fallback:           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”˜    â”‚ manualCanvasRender()â”‚
                       â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Success?                       â”‚
        â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚ Yes                   â”‚ No
           â”‚                       â”‚
      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ S3 URL  â”‚          â”‚ Fallback:        â”‚
      â”‚ âœ…      â”‚          â”‚ Use dataUrl      â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â”‚ âš ï¸ Warning       â”‚
           â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Create Payload     â”‚
            â”‚ Show Notification  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CORS Handling Process

```
For Each Image in Canvas:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get Image Source     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Test if CORS OK  â”‚
    â”‚ (drawImage test) â”‚
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚ YES      â”‚ NO
       â”‚          â”‚
   Continue   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ Reload Image with:       â”‚
             â”‚ - crossOrigin="anonymous"â”‚
             â”‚ - ?_cors=timestamp       â”‚
             â”‚ - Retry drawImage test  â”‚
             â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                 â”‚ SUCCESS           â”‚ FAILED
                 â”‚                   â”‚
            Use Image          Log Warning
                              Use Fallback
```

---

## Memory & Performance Profile

```
Timeline:
â”œâ”€ 0ms     - Save triggered
â”œâ”€ 10ms    - Process images (CORS check)
â”œâ”€ 50ms    - Export to canvas (fabric.toDataURL)
â”œâ”€ 100ms   - Convert to Blob
â”œâ”€ 150ms   - Generate File object
â”œâ”€ 200ms   - Get presigned URL (network)
â”‚          â””â”€ ~100-200ms network latency
â”œâ”€ 300ms   - Upload to S3 (network)
â”‚          â””â”€ ~100-300ms network latency
â”œâ”€ 400ms   - S3 returns success
â”œâ”€ 450ms   - Create payload
â””â”€ 500ms   - Total (typical)

Memory Usage:
â”œâ”€ Canvas size: ~1-5MB (in memory)
â”œâ”€ Blob (PNG): ~1-3MB (temporary)
â”œâ”€ File object: <1MB (reference only)
â””â”€ Total: ~2-8MB (cleaned up after)

Optimization Potential:
â”œâ”€ Reduce quality: 0.7 instead of 1.0 â†’ -30% size
â”œâ”€ Reduce multiplier: 1 instead of 2 â†’ -75% export time
â”œâ”€ Parallel uploads: Upload while still exporting
â””â”€ Compression: Pre-compress before upload
```

---

## Component Interaction Map

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Browser       â”‚
                  â”‚ Unsplash Images â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ crossOrigin="anonymous"
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          Canvas (fabric.js)         â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚ â”‚ Objects                        â”‚  â”‚
        â”‚ â”œâ”€ Images (Unsplash URLs)       â”‚  â”‚
        â”‚ â”œâ”€ Text (menu items)            â”‚  â”‚
        â”‚ â”œâ”€ Shapes (background)          â”‚  â”‚
        â”‚ â””â”€ ...                          â”‚  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       useHistory Hook               â”‚
        â”‚  â”œâ”€ save() function                 â”‚
        â”‚  â”œâ”€ saveCallback (debounced)        â”‚
        â”‚  â””â”€ Undo/Redo history              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    canvasExportService              â”‚
        â”‚  â”œâ”€ exportCanvasToBlob()            â”‚
        â”‚  â”œâ”€ CORS handling                   â”‚
        â”‚  â””â”€ Fallback rendering             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   presignedUrlService               â”‚
        â”‚  â”œâ”€ getPresignedUrl()               â”‚
        â”‚  â””â”€ uploadFileToS3()                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       AWS S3 Bucket                 â”‚
        â”‚  â””â”€ template_designs/               â”‚
        â”‚     â””â”€ {timestamp}_{random}.png    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Type System

```
TypeScript Types:

canvasExportService.ts
â”œâ”€ CanvasExportOptions
â”‚  â”œâ”€ format: 'png' | 'jpg' | 'svg' | 'json'
â”‚  â”œâ”€ quality: number
â”‚  â””â”€ multiplier: number
â”‚
â”œâ”€ ExportAndUploadResult
â”‚  â”œâ”€ success: boolean
â”‚  â”œâ”€ imageUrl?: string
â”‚  â”œâ”€ imageFile?: File
â”‚  â”œâ”€ error?: string
â”‚  â””â”€ timestamp: string
â”‚
â”œâ”€ TemplateExportPayload
â”‚  â”œâ”€ title: string
â”‚  â”œâ”€ json: string
â”‚  â”œâ”€ image: string
â”‚  â”œâ”€ imageFile?: File
â”‚  â””â”€ metadata?: {...}
â”‚
â””â”€ S3UploadOptions
   â”œâ”€ title?: string
   â”œâ”€ format?: 'png' | 'jpg'
   â”œâ”€ quality?: number
   â””â”€ multiplier?: number

editor.ts
â”œâ”€ EditorHookProps
â”‚  â””â”€ saveCallback?: (values: {
â”‚     â”œâ”€ json: string
â”‚     â”œâ”€ height: number
â”‚     â”œâ”€ width: number
â”‚     â””â”€ dataUrl?: string
â”‚     }) => void
â”‚
â””â”€ ActiveTool = 'select' | 'draw' | 'images' | ...
```

---

## Deployment Checklist

```
Pre-Deployment:
â˜ All TypeScript compiles (no errors)
â˜ No console errors in dev mode
â˜ Export functionality tested
â˜ S3 upload tested
â˜ CORS images handled
â˜ Error fallbacks working
â˜ Snackbar notifications display
â˜ Console logging outputs correctly

AWS Configuration:
â˜ S3 bucket exists
â˜ CORS headers configured on S3
â˜ IAM user has permissions
â˜ Presigned URL service working
â˜ Bucket public read access (if needed)

Post-Deployment:
â˜ Test first save uploads to S3
â˜ Verify S3 URL is accessible
â˜ Check CloudWatch for errors
â˜ Monitor S3 storage usage
â˜ Set up bucket lifecycle policy
â˜ Enable versioning (optional)
â˜ Configure backup (optional)
```

---

This diagram shows the complete architecture, data flow, and integration points of the canvas export and S3 upload system!
